From a28ba53e42fe14c5c57dcd24d84d09058c698402 Mon Sep 17 00:00:00 2001
From: Jonas Gorski <jonas.gorski@gmail.com>
Date: Wed, 12 Jul 2023 11:01:08 +0200
Subject: [PATCH 07/12] net: dsa: b53: implement port_vlan_fast_age

Signed-off-by: Jonas Gorski <jonas.gorski@gmail.com>
---
 drivers/net/dsa/b53/b53_common.c | 17 +++++++++++++++++
 drivers/net/dsa/b53/b53_priv.h   |  1 +
 drivers/net/dsa/bcm_sf2.c        |  1 +
 3 files changed, 19 insertions(+)

--- a/drivers/net/dsa/b53/b53_common.c
+++ b/drivers/net/dsa/b53/b53_common.c
@@ -591,6 +591,14 @@ static int b53_fast_age_vlan(struct b53_
 	return b53_flush_arl(dev, FAST_AGE_VLAN);
 }
 
+static int b53_fast_age_port_vlan(struct b53_device *dev, int port, u16 vid)
+{
+	b53_write8(dev, B53_CTRL_PAGE, B53_FAST_AGE_PORT_CTRL, port);
+	b53_write16(dev, B53_CTRL_PAGE, B53_FAST_AGE_VID_CTRL, vid);
+
+	return b53_flush_arl(dev, FAST_AGE_PORT | FAST_AGE_VLAN);
+}
+
 void b53_imp_vlan_setup(struct dsa_switch *ds, int cpu_port)
 {
 	struct b53_device *dev = ds->priv;
@@ -2469,6 +2477,14 @@ void b53_br_fast_age(struct dsa_switch *
 }
 EXPORT_SYMBOL(b53_br_fast_age);
 
+int b53_br_port_vlan_fast_age(struct dsa_switch *ds, int port, u16 vid)
+{
+	struct b53_device *dev = ds->priv;
+
+	return b53_fast_age_port_vlan(dev, port, vid);
+}
+EXPORT_SYMBOL(b53_br_port_vlan_fast_age);
+
 int b53_br_flags_pre(struct dsa_switch *ds, int port,
 		     struct switchdev_brport_flags flags,
 		     struct netlink_ext_ack *extack)
@@ -2772,6 +2788,7 @@ static const struct dsa_switch_ops b53_s
 	.port_bridge_flags	= b53_br_flags,
 	.port_stp_state_set	= b53_br_set_stp_state,
 	.port_fast_age		= b53_br_fast_age,
+	.port_vlan_fast_age	= b53_br_port_vlan_fast_age,
 	.port_vlan_filtering	= b53_vlan_filtering,
 	.port_vlan_add		= b53_vlan_add,
 	.port_vlan_del		= b53_vlan_del,
--- a/drivers/net/dsa/b53/b53_priv.h
+++ b/drivers/net/dsa/b53/b53_priv.h
@@ -507,6 +507,7 @@ int b53_br_join(struct dsa_switch *ds, i
 void b53_br_leave(struct dsa_switch *ds, int port, struct dsa_bridge bridge);
 void b53_br_set_stp_state(struct dsa_switch *ds, int port, u8 state);
 void b53_br_fast_age(struct dsa_switch *ds, int port);
+int b53_br_port_vlan_fast_age(struct dsa_switch *ds, int port, u16 vid);
 int b53_br_flags_pre(struct dsa_switch *ds, int port,
 		     struct switchdev_brport_flags flags,
 		     struct netlink_ext_ack *extack);
--- a/drivers/net/dsa/bcm_sf2.c
+++ b/drivers/net/dsa/bcm_sf2.c
@@ -1242,6 +1242,7 @@ static const struct dsa_switch_ops bcm_s
 	.port_bridge_flags	= b53_br_flags,
 	.port_stp_state_set	= b53_br_set_stp_state,
 	.port_fast_age		= b53_br_fast_age,
+	.port_vlan_fast_age	= b53_br_port_vlan_fast_age,
 	.port_vlan_filtering	= b53_vlan_filtering,
 	.port_vlan_add		= b53_vlan_add,
 	.port_vlan_del		= b53_vlan_del,
